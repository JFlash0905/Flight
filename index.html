<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Felis NBA GM â€” Real Teams + Real Players Only</title>
  <style>
    :root{ --bg:#0b0f14; --card:#111827; --muted:#94a3b8; --txt:#e5e7eb; --accent:#22c55e; --warn:#f59e0b; --bad:#ef4444; --line:#1f2937; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: ui-sans-serif,system-ui,-apple-system,"PingFang TC","Noto Sans TC",Arial; background:linear-gradient(180deg,#06080c 0%, #0b0f14 40%, #06080c 100%); color:var(--txt); }
    .wrap{ max-width:1100px; margin:0 auto; padding:14px 14px 94px; }
    header{ display:flex; gap:12px; align-items:center; justify-content:space-between; position:sticky; top:0; background:rgba(11,15,20,.92); backdrop-filter: blur(10px); border-bottom:1px solid var(--line); padding:10px 14px; z-index:10; }
    .title{ display:flex; flex-direction:column; gap:2px; }
    .title h1{ margin:0; font-size:16px; letter-spacing:.2px; }
    .title .sub{ font-size:12px; color:var(--muted); }
    .pill{ font-size:12px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; color:var(--muted); }
    nav{ position:fixed; left:0; right:0; bottom:0; background:rgba(6,8,12,.95); border-top:1px solid var(--line); padding:10px 10px calc(10px + env(safe-area-inset-bottom)); }
    .tabs{ display:flex; gap:8px; max-width:1100px; margin:0 auto; }
    .tab{ flex:1; text-align:center; padding:10px 8px; border:1px solid var(--line); border-radius:14px; font-size:12px; color:var(--muted); cursor:pointer; user-select:none; }
    .tab.on{ border-color:rgba(34,197,94,.45); color:#d1fae5; background:rgba(34,197,94,.08); }
    .grid{ display:grid; grid-template-columns: 1.1fr .9fr; gap:12px; margin-top:12px; }
    @media (max-width: 920px){ .grid{ grid-template-columns:1fr; } }
    .card{ background:rgba(17,24,39,.78); border:1px solid var(--line); border-radius:18px; padding:12px; box-shadow: 0 8px 30px rgba(0,0,0,.28); }
    .card h2{ margin:0 0 10px; font-size:14px; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    select, button, input, textarea{
      background:#0b1220; color:var(--txt); border:1px solid var(--line); border-radius:12px; padding:10px 10px; font-size:13px;
    }
    button{ cursor:pointer; }
    button.primary{ border-color:rgba(34,197,94,.5); background:rgba(34,197,94,.14); }
    button.danger{ border-color:rgba(239,68,68,.5); background:rgba(239,68,68,.12); }
    button.ghost{ background:transparent; }
    button:disabled{ opacity:.45; cursor:not-allowed; }
    .kpi{ display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; }
    @media (max-width: 520px){ .kpi{ grid-template-columns: repeat(2, 1fr); } }
    .k{ border:1px solid var(--line); border-radius:16px; padding:10px; background:rgba(11,18,32,.55); }
    .k .v{ font-size:18px; font-weight:700; }
    .k .l{ font-size:12px; color:var(--muted); }
    table{ width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border:1px solid var(--line); border-radius:16px; }
    th, td{ padding:10px 10px; font-size:12px; border-bottom:1px solid var(--line); vertical-align:top;}
    th{ text-align:left; color:var(--muted); background:rgba(11,18,32,.55); position:sticky; top:0; z-index:2; }
    tr:last-child td{ border-bottom:none; }
    .tag{ display:inline-flex; gap:6px; align-items:center; font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid var(--line); color:var(--muted); }
    .tag.good{ border-color:rgba(34,197,94,.45); color:#d1fae5; background:rgba(34,197,94,.10); }
    .tag.warn{ border-color:rgba(245,158,11,.45); color:#ffedd5; background:rgba(245,158,11,.10); }
    .tag.bad{ border-color:rgba(239,68,68,.45); color:#fee2e2; background:rgba(239,68,68,.10); }
    .muted{ color:var(--muted); }
    .log{ max-height:280px; overflow:auto; border:1px solid var(--line); border-radius:16px; padding:10px; background:rgba(11,18,32,.55); font-size:12px; }
    .log p{ margin:0 0 8px; color:#cbd5e1; }
    .split{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width: 720px){ .split{ grid-template-columns:1fr; } }
    .hint{ font-size:12px; color:var(--muted); line-height:1.5; }
  </style>
</head>
<body>
<header>
  <div class="title">
    <h1>Felis NBA GMï¼ˆçœŸå¯¦çƒéšŠ + çœŸå¯¦çƒå“¡å¼·åˆ¶ï¼‰</h1>
    <div class="sub">å­£å¾Œè³½ï½œå¤šå­£å¾ªç’°ï½œäº¤æ˜“ï½œé¤Šå‚·ï½œç–²å‹ï½œè‡ªå‹•å­˜æª”ï½œéšŠä¼é–å®š</div>
  </div>
  <div class="row">
    <span class="pill" id="pillSeason">Season: â€”</span>
    <span class="pill" id="pillDay">Day: â€”</span>
    <span class="pill" id="pillLock">Team: â€”</span>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <div class="card" id="panelMain"></div>

    <div class="card">
      <h2>æ§åˆ¶å°</h2>
      <div class="row" style="margin-bottom:10px;">
        <select id="selMyTeam"></select>
        <button class="primary" id="btnLockTeam">é–å®šçƒéšŠ</button>
        <button class="primary" id="btnNewSeason">é€²å…¥æ–°è³½å­£ï¼ˆä¼‘è³½å­£ï¼‰</button>
        <button id="btnSave">æ‰‹å‹•å„²å­˜</button>
        <button class="ghost" id="btnLoad">è®€å–å­˜æª”</button>
        <button class="danger" id="btnReset">é‡ç½®ï¼ˆæ¸…æ‰é–å®š/å­˜æª”ï¼‰</button>
      </div>

      <div class="kpi" style="margin-bottom:10px;">
        <div class="k"><div class="v" id="kpiMyOvr">â€”</div><div class="l">æˆ‘éšŠ OVR</div></div>
        <div class="k"><div class="v" id="kpiCap">â€”</div><div class="l">è–ªè³‡ / ä¸Šé™</div></div>
        <div class="k"><div class="v" id="kpiRec">â€”</div><div class="l">æˆ°ç¸¾</div></div>
        <div class="k"><div class="v" id="kpiReal">â€”</div><div class="l">çœŸå¯¦åå–®æª¢æŸ¥</div></div>
      </div>

      <div class="row" style="margin-bottom:10px;">
        <button class="primary" id="btnSim1">æ¨¡æ“¬ 1 å¤©</button>
        <button class="primary" id="btnSim7">æ¨¡æ“¬ 7 å¤©</button>
        <button class="primary" id="btnSimToEnd">æ¨¡æ“¬åˆ°å­£æœ« + å­£å¾Œè³½</button>
      </div>

      <div class="hint" style="margin-bottom:10px;">
        âœ… ä½ è¦æ±‚ã€Œå…¨çœŸå¯¦ã€ï¼šæœ¬ä½œæœƒé˜»æ­¢æ¨¡æ“¬ï¼Œç›´åˆ°ä½ åŒ¯å…¥å„éšŠçœŸå¯¦çƒå“¡åå–®ã€‚<br/>
        âœ… iPad é£›èˆªï¼šç”¨ã€ŒåŠ å…¥ä¸»ç•«é¢ã€é–‹ï¼Œä¸è¦é‡æ–°æ•´ç†/æœå°‹é é¢ã€‚
      </div>

      <h2>äº‹ä»¶ç´€éŒ„</h2>
      <div class="log" id="log"></div>
    </div>
  </div>
</div>

<nav>
  <div class="tabs">
    <div class="tab on" data-tab="team">çƒéšŠ</div>
    <div class="tab" data-tab="league">è¯ç›Ÿ</div>
    <div class="tab" data-tab="trade">äº¤æ˜“</div>
    <div class="tab" data-tab="fa">è‡ªç”±å¸‚å ´</div>
    <div class="tab" data-tab="import">åŒ¯å…¥åå–®</div>
  </div>
</nav>

<script>
/* =========================
   Core Helpers
========================= */
const $ = (q)=>document.querySelector(q);
const $$ = (q)=>Array.from(document.querySelectorAll(q));
const rnd = (a,b)=>Math.random()*(b-a)+a;
const rndi = (a,b)=>Math.floor(rnd(a,b+1));
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
const fmt$ = (m)=>`$${m.toFixed(1)}M`;
const uid = ()=>Math.random().toString(36).slice(2,10);

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }
function log(msg){
  const el = $("#log");
  const p = document.createElement("p");
  p.textContent = msg;
  el.prepend(p);
}
function autosave(){
  try{ localStorage.setItem("felis_nba_gm_save", JSON.stringify(state)); }catch(e){}
}
function save(){ autosave(); log("ğŸ’¾ å·²å„²å­˜ï¼ˆæœ¬æ©Ÿ localStorageï¼‰ã€‚"); }
function load(){
  const raw = localStorage.getItem("felis_nba_gm_save");
  if(!raw){ alert("æ²’æœ‰æ‰¾åˆ°å­˜æª”ã€‚"); return; }
  state = JSON.parse(raw);
  log("ğŸ“‚ å·²è®€å–å­˜æª”ã€‚");
  render();
}

/* =========================
   Real Teams (30)
========================= */
const TEAMS = [
  {id:"ATL", name:"Atlanta Hawks", conf:"East", div:"Southeast"},
  {id:"BOS", name:"Boston Celtics", conf:"East", div:"Atlantic"},
  {id:"BKN", name:"Brooklyn Nets", conf:"East", div:"Atlantic"},
  {id:"CHA", name:"Charlotte Hornets", conf:"East", div:"Southeast"},
  {id:"CHI", name:"Chicago Bulls", conf:"East", div:"Central"},
  {id:"CLE", name:"Cleveland Cavaliers", conf:"East", div:"Central"},
  {id:"DAL", name:"Dallas Mavericks", conf:"West", div:"Southwest"},
  {id:"DEN", name:"Denver Nuggets", conf:"West", div:"Northwest"},
  {id:"DET", name:"Detroit Pistons", conf:"East", div:"Central"},
  {id:"GSW", name:"Golden State Warriors", conf:"West", div:"Pacific"},
  {id:"HOU", name:"Houston Rockets", conf:"West", div:"Southwest"},
  {id:"IND", name:"Indiana Pacers", conf:"East", div:"Central"},
  {id:"LAC", name:"LA Clippers", conf:"West", div:"Pacific"},
  {id:"LAL", name:"Los Angeles Lakers", conf:"West", div:"Pacific"},
  {id:"MEM", name:"Memphis Grizzlies", conf:"West", div:"Southwest"},
  {id:"MIA", name:"Miami Heat", conf:"East", div:"Southeast"},
  {id:"MIL", name:"Milwaukee Bucks", conf:"East", div:"Central"},
  {id:"MIN", name:"Minnesota Timberwolves", conf:"West", div:"Northwest"},
  {id:"NOP", name:"New Orleans Pelicans", conf:"West", div:"Southwest"},
  {id:"NYK", name:"New York Knicks", conf:"East", div:"Atlantic"},
  {id:"OKC", name:"Oklahoma City Thunder", conf:"West", div:"Northwest"},
  {id:"ORL", name:"Orlando Magic", conf:"East", div:"Southeast"},
  {id:"PHI", name:"Philadelphia 76ers", conf:"East", div:"Atlantic"},
  {id:"PHX", name:"Phoenix Suns", conf:"West", div:"Pacific"},
  {id:"POR", name:"Portland Trail Blazers", conf:"West", div:"Northwest"},
  {id:"SAC", name:"Sacramento Kings", conf:"West", div:"Pacific"},
  {id:"SAS", name:"San Antonio Spurs", conf:"West", div:"Southwest"},
  {id:"TOR", name:"Toronto Raptors", conf:"East", div:"Atlantic"},
  {id:"UTA", name:"Utah Jazz", conf:"West", div:"Northwest"},
  {id:"WAS", name:"Washington Wizards", conf:"East", div:"Southeast"},
];

/* =========================
   Player Model (Real-only enforced)
========================= */
function P(name,pos,team,ovr,age,salary,years){
  return {
    id: uid(),
    name, pos, team,
    ovr: clamp(parseInt(ovr,10)||75, 40, 99),
    age: clamp(parseInt(age,10)||26, 18, 45),
    salary: clamp(parseFloat(salary)||5.0, 0.5, 90.0),
    years: clamp(parseInt(years,10)||1, 1, 5),
    pot: clamp((parseInt(ovr,10)||75) + rndi(0,8), 50, 99),
    inj: 0,
    rehab: "normal", // normal | fast | force
    fatigue: 0
  };
}

// ã€ŒçœŸå¯¦çƒå“¡æª¢æŸ¥ã€ï¼šæˆ‘å€‘ä¸åˆ¤æ–·æ˜¯ä¸æ˜¯NBAç¾å½¹ï¼ˆé‚£è¦å¤–éƒ¨è³‡æ–™ï¼‰ï¼Œä½†æˆ‘å€‘å¯ä»¥å¼·åˆ¶ï¼š
// - ä¸èƒ½åŒ…å« "Free Agent"ã€"Starter"ã€"Role"ã€"#1234" ä¹‹é¡å‡å
// - å¿…é ˆæœ‰è‡³å°‘å…©å€‹å­—æ¯ã€ä¸”ä¸å«æ˜é¡¯ä½”ä½é—œéµå­—
const FAKE_NAME_PATTERNS = [
  /free agent/i, /starter/i, /backup/i, /role/i, /rookie/i,
  /#\d{3,}/, /test/i, /dummy/i
];
function isFakeName(name){
  const s = String(name||"").trim();
  if(s.length < 4) return true;
  if(FAKE_NAME_PATTERNS.some(re=>re.test(s))) return true;
  return false;
}

/* =========================
   State
========================= */
const SAVE_KEY = "felis_nba_gm_save";
const LOCK_KEY = "felis_my_team_locked";

let state = null;
let currentTab = "team";

function newState(){
  const teams = TEAMS.map(t=>({
    ...t,
    w:0,l:0,pf:0,pa:0,
    cap: 142.0,
    medical: rndi(2,4), // é†«ç™‚ç­‰ç´š 1~5ï¼ˆè¶Šé«˜æ¢å¾©è¶Šå¿«ï¼‰
  }));

  // åˆå§‹ä¸å…§å»ºä»»ä½•çƒå“¡ï¼ˆç¬¦åˆä½ ã€Œå…¨çœŸå¯¦ã€è¦æ±‚ï¼šä½ å¿…é ˆåŒ¯å…¥çœŸå¯¦åå–®ï¼‰
  // ä½†ä¿ç•™ä¸€å€‹ç©ºé™£å®¹çµæ§‹ï¼ŒåŒ¯å…¥å¾Œæ‰èƒ½é–‹å­£æ¨¡æ“¬ã€‚
  const players = [];
  const fa = []; // è‡ªç”±å¸‚å ´ï¼šåªæ¥å—ä½ åŒ¯å…¥æˆ–åˆ°æœŸåˆç´„æµå…¥ï¼Œä¸å†äº‚ç”Ÿå‡äºº

  return {
    ver:"2.0-real-only",
    season: "2025-26",
    year: 2025,
    day: 1,
    myTeam: "GSW",
    teams,
    players,
    fa,
    schedule: makeSchedule(TEAMS.map(t=>t.id), 82),
    playoffsDone: false,
  };
}

function teamPlayers(teamId){
  return state.players.filter(p=>p.team===teamId).sort((a,b)=>b.ovr-a.ovr);
}
function payroll(teamId){
  return teamPlayers(teamId).reduce((s,p)=>s+p.salary,0);
}
function teamOVR(teamId){
  const roster = teamPlayers(teamId).filter(p=>p.inj===0); // å—å‚·ä¸ç®—é€²å³æˆ°åŠ›ï¼ˆæ›´åƒçœŸå¯¦ï¼‰
  const top = roster.slice(0,8);
  const avg = top.reduce((s,p)=>s+p.ovr,0)/Math.max(1,top.length);
  return Math.round(avg);
}
function sortStandings(a,b){
  if(b.w!==a.w) return b.w-a.w;
  const diffA = a.pf-a.pa, diffB = b.pf-b.pa;
  return diffB-diffA;
}

/* =========================
   Schedule: daily games, no "empty days"
========================= */
function makeSchedule(teamIds, gamesPerTeam=82){
  const need = {};
  teamIds.forEach(id=>need[id]=gamesPerTeam);

  const days = [];
  const totalDays = 175;
  for(let d=0; d<totalDays; d++){
    const today = [];
    const pool = teamIds.filter(id=>need[id]>0).sort(()=>Math.random()-0.5);
    const targetGames = Math.min(rndi(6,10), Math.floor(pool.length/2));

    const used = new Set();
    let tries = 0;
    while(today.length < targetGames && tries < 300){
      tries++;
      const a = pool[rndi(0,pool.length-1)];
      const b = pool[rndi(0,pool.length-1)];
      if(!a || !b || a===b) continue;
      if(used.has(a) || used.has(b)) continue;
      if(need[a]<=0 || need[b]<=0) continue;

      const home = Math.random()<0.5 ? a : b;
      const away = home===a ? b : a;

      today.push({home, away});
      used.add(a); used.add(b);
      need[a]--; need[b]--;
    }

    if(today.length===0){
      const left = teamIds.filter(id=>need[id]>0);
      if(left.length>=2){
        const a = left[0], b = left[1];
        today.push({home:a, away:b});
        need[a]--; need[b]--;
      }
    }

    days.push(today);
  }
  return days;
}

/* =========================
   Real-only Gate (blocks sim until all teams imported)
========================= */
function realRosterCheck(){
  // å¿…é ˆæ¯éšŠè‡³å°‘ 13 äººï¼ˆä½ å¯ä»¥æ”¹æˆ15æ›´åš´ï¼‰
  const problems = [];
  for(const t of TEAMS){
    const roster = teamPlayers(t.id);
    if(roster.length < 13) problems.push(`${t.id} å°‘æ–¼13äººï¼ˆ${roster.length}ï¼‰`);
    for(const p of roster){
      if(isFakeName(p.name)) problems.push(`${t.id} å‡ºç¾ç–‘ä¼¼å‡åï¼š${p.name}`);
    }
  }
  // FA ä¹Ÿä¸èƒ½æ˜¯å‡åï¼ˆå¦‚æœä½ åŒ¯å…¥FAï¼‰
  for(const p of state.fa){
    if(isFakeName(p.name)) problems.push(`FA å‡åï¼š${p.name}`);
  }
  return problems;
}

function ensureCanSim(){
  const locked = localStorage.getItem(LOCK_KEY);
  if(!locked){ return {ok:false, msg:"è«‹å…ˆé¸éšŠä¸¦æŒ‰ã€Œé–å®šçƒéšŠã€ã€‚ï¼ˆé–å®šå¾Œé™¤éé‡ç½®ä¸èƒ½æ›ï¼‰"}; }

  const probs = realRosterCheck();
  if(probs.length>0){
    return {ok:false, msg:"çœŸå¯¦åå–®æœªå®Œæˆï¼Œå·²é˜»æ­¢æ¨¡æ“¬ã€‚\n\néœ€è¦è™•ç†ï¼š\n- " + probs.slice(0,12).join("\n- ") + (probs.length>12?`\n...ï¼ˆå…±${probs.length}é …ï¼‰`:"") + "\n\nè«‹åˆ°ã€ŒåŒ¯å…¥åå–®ã€è²¼ä¸Šå„éšŠçœŸå¯¦çƒå“¡åå–®ã€‚"};
  }
  return {ok:true, msg:"ok"};
}

/* =========================
   Injury / Rehab / Fatigue
========================= */
function injuryRecoveryRate(teamId, rehab){
  const med = state.teams.find(t=>t.id===teamId)?.medical ?? 3;
  const base = 1 + (med-3)*0.15; // 3=>1.0
  if(rehab==="fast") return base * 1.35;
  if(rehab==="force") return base * 0.10;
  return base;
}
function reinjuryRisk(p){
  let risk = 0.008;
  if(p.rehab==="fast") risk += 0.02;
  if(p.rehab==="force") risk += 0.07;
  if(p.fatigue > 70) risk += 0.02;
  return risk;
}

/* =========================
   Simulation
========================= */
function simulateDay(){
  const gate = ensureCanSim();
  if(!gate.ok){ alert(gate.msg); return; }

  const dayIndex = state.day - 1;
  const games = state.schedule[dayIndex] || [];
  if(games.length===0){
    log(`Day ${state.day}: æ²’æœ‰è³½ç¨‹ï¼ˆç†è«–ä¸Šå¾ˆå°‘ç™¼ç”Ÿï¼‰ã€‚`);
    state.day++;
    autosave();
    return;
  }

  for(const g of games){
    playGame(g.away, g.home);
  }
  dailyUpdates();
  state.day++;
  autosave();
}

function playGame(awayId, homeId){
  const awayOVR = teamOVR(awayId);
  const homeOVR = teamOVR(homeId) + 2; // ä¸»å ´å„ªå‹¢
  const awayInj = teamPlayers(awayId).filter(p=>p.inj>0).length;
  const homeInj = teamPlayers(homeId).filter(p=>p.inj>0).length;

  const awayAdj = awayOVR - awayInj*1.0;
  const homeAdj = homeOVR - homeInj*1.0;

  const pHome = 1/(1+Math.pow(10, (awayAdj-homeAdj)/12));
  const homeWin = Math.random() < pHome;

  const base = 109;
  const spread = (homeAdj - awayAdj) * 1.1 + rnd(-7,7);
  const homePts = Math.round(base + spread + rnd(-6,6));
  const awayPts = Math.round(base - spread + rnd(-6,6));

  const tHome = state.teams.find(t=>t.id===homeId);
  const tAway = state.teams.find(t=>t.id===awayId);

  if(homeWin){ tHome.w++; tAway.l++; } else { tAway.w++; tHome.l++; }
  tHome.pf += homePts; tHome.pa += awayPts;
  tAway.pf += awayPts; tAway.pa += homePts;

  const my = state.myTeam;
  if(homeId===my || awayId===my){
    const meHome = homeId===my;
    const win = (meHome && homeWin) || (!meHome && !homeWin);
    const vs = TEAMS.find(t=>t.id===(meHome?awayId:homeId)).name;
    log(`Day ${state.day}: ${win ? "âœ… å‹" : "âŒ è² "} vs ${vs} â€” ${meHome?homePts:awayPts}-${meHome?awayPts:homePts}`);
  }
}

function dailyUpdates(){
  // ç–²å‹ + å—å‚· + å¾©ç™¼ + é¤Šå‚·
  for(const t of TEAMS){
    const roster = teamPlayers(t.id);
    const top10 = roster.slice(0,10).map(p=>p.id);
    for(const p of roster){
      const plays = top10.includes(p.id);

      // é¤Šå‚·æ¢å¾©
      if(p.inj > 0){
        const rate = injuryRecoveryRate(p.team, p.rehab);
        p.inj = Math.max(0, p.inj - 1);
        if(Math.random() < (rate - 1)) p.inj = Math.max(0, p.inj - 1);
        p.fatigue = clamp(p.fatigue - rndi(3,7), 0, 100);
        if(p.inj===0) p.rehab = "normal";
        continue;
      }

      // ç–²å‹è®ŠåŒ–
      if(plays){
        p.fatigue = clamp(p.fatigue + rndi(2,5), 0, 100);
      }else{
        p.fatigue = clamp(p.fatigue - rndi(3,7), 0, 100);
      }

      // å—å‚·æ©Ÿç‡ï¼šåŸºç¤ + ç–²å‹åŠ æˆ
      if(plays){
        const base = 0.0038;
        const extra = (p.fatigue>85) ? 0.007 : (p.fatigue>65 ? 0.002 : 0);
        if(Math.random() < (base + extra)){
          p.inj = rndi(3,21);
          log(`ğŸš‘ å‚·ç—…ï¼š${p.name}ï¼ˆ${p.team}ï¼‰ç¼ºé™£ ${p.inj} å¤©`);
        }
      }

      // å¾©ç™¼ï¼ˆå°¤å…¶å¼·è¡Œ/åŠ é€Ÿï¼‰
      if(plays && Math.random() < reinjuryRisk(p)){
        const sev = (p.rehab==="force") ? rndi(6,18) : rndi(3,10);
        p.inj = sev;
        log(`â™»ï¸ å¾©ç™¼ï¼š${p.name}ï¼ˆ${p.team}ï¼‰å†æ¬¡ç¼ºé™£ ${p.inj} å¤©`);
      }
    }
  }
}

/* =========================
   Playoffs & Multi-season Loop
========================= */
function winProb(aId,bId){
  const aO = teamOVR(aId);
  const bO = teamOVR(bId);
  return 1/(1+Math.pow(10,(bO-aO)/12));
}
function seriesWinner(aId,bId,bestOf=7){
  const need = Math.ceil(bestOf/2);
  let a=0,b=0;
  while(a<need && b<need){
    if(Math.random() < winProb(aId,bId)) a++; else b++;
  }
  return a>b ? aId : bId;
}
function bracketWinner(seedIds){
  const q1 = seriesWinner(seedIds[0], seedIds[7], 7);
  const q2 = seriesWinner(seedIds[3], seedIds[4], 7);
  const q3 = seriesWinner(seedIds[1], seedIds[6], 7);
  const q4 = seriesWinner(seedIds[2], seedIds[5], 7);
  const s1 = seriesWinner(q1, q2, 7);
  const s2 = seriesWinner(q3, q4, 7);
  return seriesWinner(s1, s2, 7);
}
function runPlayoffs(){
  const east = state.teams.filter(t=>t.conf==="East").sort(sortStandings).slice(0,8);
  const west = state.teams.filter(t=>t.conf==="West").sort(sortStandings).slice(0,8);
  const winnerEast = bracketWinner(east.map(t=>t.id));
  const winnerWest = bracketWinner(west.map(t=>t.id));
  const champ = seriesWinner(winnerEast, winnerWest, 7);
  log(`ğŸ† å† è»ï¼š${TEAMS.find(t=>t.id===champ).name}`);
  state.playoffsDone = true;
}

/* =========================
   Offseason (Season-to-season realism)
   - Contract years decrease
   - Expiring deals -> Free Agency
   - Seasonal decline (NOT daily) so Curry won't "season-end collapse"
========================= */
function offseasonAdvance(){
  // reset records
  for(const t of state.teams){ t.w=0; t.l=0; t.pf=0; t.pa=0; }
  state.day = 1;
  state.playoffsDone = false;

  // season year advance
  state.year += 1;
  state.season = `${state.year}-${String((state.year+1)%100).padStart(2,"0")}`;

  // age, contracts
  const toFA = [];
  for(const p of state.players){
    p.age += 1;
    p.years = Math.max(0, p.years - 1);

    // seasonal decline: è€å°‡å°å¹…ä¸‹æ»‘ï¼Œè¶…å·¨æ›´ä¿è­·
    if(p.age >= 33){
      const protect = p.ovr >= 90;
      const drop = protect ? rndi(0,1) : rndi(0,2);
      p.ovr = Math.max(60, p.ovr - drop);
    } else if(p.age <= 24){
      // young growth
      const up = (p.ovr < p.pot) ? rndi(0,2) : 0;
      p.ovr = Math.min(p.pot, p.ovr + up);
    }

    // fatigue reset-ish
    p.fatigue = clamp(p.fatigue - rndi(10,25), 0, 100);

    if(p.years===0){
      toFA.push(p);
    }
  }

  // move expiring to FA
  if(toFA.length>0){
    for(const p of toFA){
      p.team = "FA";
      p.years = 1;
      p.rehab = "normal";
      p.inj = 0;
      state.fa.push(p);
    }
    state.players = state.players.filter(p=>p.team!=="FA");
    log(`ğŸ§¾ ä¼‘è³½å­£ï¼š${toFA.length} ä½åˆ°æœŸçƒå“¡é€²å…¥è‡ªç”±å¸‚å ´ã€‚`);
  }

  // rebuild schedule
  state.schedule = makeSchedule(TEAMS.map(t=>t.id), 82);
  autosave();
}

/* =========================
   Trade (real-only players)
========================= */
function proposeTrade(giveIds, getIds, otherTeamId){
  const my = state.myTeam;
  const mine = state.players.filter(p=>giveIds.includes(p.id) && p.team===my);
  const theirs = state.players.filter(p=>getIds.includes(p.id) && p.team===otherTeamId);

  const myVal = mine.reduce((s,p)=>s+p.ovr + p.pot*0.08 - p.age*0.15,0);
  const thVal = theirs.reduce((s,p)=>s+p.ovr + p.pot*0.08 - p.age*0.15,0);

  const mySal = mine.reduce((s,p)=>s+p.salary,0);
  const thSal = theirs.reduce((s,p)=>s+p.salary,0);

  const salaryOk = (mySal>0 && Math.abs(mySal-thSal)/mySal <= 0.25);

  // acceptance rule
  const diff = myVal - thVal;
  const accept = salaryOk && diff >= -2.5;

  return {accept, myVal, thVal, mySal, thSal, salaryOk};
}
function executeTrade(giveIds, getIds, otherTeamId){
  const my = state.myTeam;
  for(const pid of giveIds){
    const p = state.players.find(x=>x.id===pid);
    if(p && p.team===my) p.team = otherTeamId;
  }
  for(const pid of getIds){
    const p = state.players.find(x=>x.id===pid);
    if(p && p.team===otherTeamId) p.team = my;
  }
  autosave();
}

/* =========================
   Import (Real players you provide)
   Format:
   TEAM: GSW
   Stephen Curry|PG|96|37|52.0|2
   ...
   ---
   TEAM: LAL
   ...
========================= */
function importRoster(text){
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(s=>s.length>0);
  let team = null;
  let added = 0, removed = 0;

  const removeExisting = (teamId)=>{
    const before = state.players.length;
    state.players = state.players.filter(p=>p.team!==teamId);
    removed += (before - state.players.length);
  };

  for(const line of lines){
    if(/^TEAM\s*:/i.test(line)){
      team = line.split(":")[1]?.trim().toUpperCase();
      if(!TEAMS.some(t=>t.id===team)) throw new Error(`æœªçŸ¥éšŠä¼ä»£ç¢¼ï¼š${team}`);
      removeExisting(team);
      continue;
    }
    if(line === "---"){ team = null; continue; }
    if(!team) continue;

    const parts = line.split("|").map(s=>s.trim());
    if(parts.length < 6) continue;
    const [name,pos,ovrS,ageS,salS,yearsS] = parts;

    if(isFakeName(name)) throw new Error(`åµæ¸¬åˆ°ç–‘ä¼¼å‡åï¼š${name}ï¼ˆè«‹åªåŒ¯å…¥çœŸå¯¦çƒå“¡å§“åï¼‰`);

    state.players.push(P(name,pos,team,ovrS,ageS,salS,yearsS));
    added++;
  }

  log(`ğŸ“¥ åŒ¯å…¥å®Œæˆï¼šæ–°å¢ ${added} äººã€ç§»é™¤èˆŠåå–® ${removed} äººï¼ˆåªæ›¿æ›ä½ å¯« TEAM çš„éšŠä¼ï¼‰`);
  autosave();
}

/* =========================
   UI Rendering
========================= */
function render(){
  $("#pillSeason").textContent = `Season: ${state.season}`;
  $("#pillDay").textContent = `Day: ${state.day}`;
  $("#pillLock").textContent = `Team: ${state.myTeam}`;

  // team selector
  const sel = $("#selMyTeam");
  sel.innerHTML = "";
  for(const t of TEAMS){
    const opt = document.createElement("option");
    opt.value = t.id;
    opt.textContent = `${t.id} â€” ${t.name}`;
    if(t.id===state.myTeam) opt.selected = true;
    sel.appendChild(opt);
  }

  const locked = localStorage.getItem(LOCK_KEY);
  sel.disabled = !!locked;
  $("#btnLockTeam").disabled = !!locked;

  // KPIs
  $("#kpiMyOvr").textContent = teamOVR(state.myTeam);
  $("#kpiCap").textContent = `${fmt$(payroll(state.myTeam))} / $${state.teams.find(t=>t.id===state.myTeam).cap.toFixed(0)}M`;
  const myTeamObj = state.teams.find(t=>t.id===state.myTeam);
  $("#kpiRec").textContent = `${myTeamObj.w}-${myTeamObj.l}`;

  const probs = realRosterCheck();
  $("#kpiReal").innerHTML = probs.length===0 ? `<span class="tag good">OK</span>` : `<span class="tag bad">${probs.length} å•é¡Œ</span>`;

  // enable/disable sim buttons based on gate
  const gate = ensureCanSim();
  $("#btnSim1").disabled = !gate.ok;
  $("#btnSim7").disabled = !gate.ok;
  $("#btnSimToEnd").disabled = !gate.ok;

  if(currentTab==="team") renderTeam();
  if(currentTab==="league") renderLeague();
  if(currentTab==="trade") renderTrade();
  if(currentTab==="fa") renderFA();
  if(currentTab==="import") renderImport();
}

function renderTeam(){
  const my = state.myTeam;
  const roster = teamPlayers(my);
  const med = state.teams.find(t=>t.id===my)?.medical ?? 3;

  $("#panelMain").innerHTML = `
    <h2>æˆ‘çš„çƒéšŠï¼š${TEAMS.find(t=>t.id===my).name} <span class="tag good">OVR ${teamOVR(my)}</span> <span class="tag">Medical ${med}/5</span></h2>
    <div class="row" style="margin-bottom:10px;">
      <span class="tag">è–ªè³‡ï¼š${fmt$(payroll(my))}</span>
      <span class="tag">ä¸Šé™ï¼š$${state.teams.find(t=>t.id===my).cap.toFixed(0)}M</span>
      <span class="tag">æˆ°ç¸¾ï¼š${state.teams.find(t=>t.id===my).w}-${state.teams.find(t=>t.id===my).l}</span>
    </div>

    <table>
      <thead><tr>
        <th>çƒå“¡</th><th>Pos</th><th>OVR</th><th>Age</th><th>Salary</th><th>Yrs</th><th>Fatigue</th><th>å‚·ç—…/é¤Šå‚·ç­–ç•¥</th>
      </tr></thead>
      <tbody>
        ${roster.map(p=>`
          <tr>
            <td>${escapeHtml(p.name)}</td>
            <td>${p.pos}</td>
            <td>${p.ovr}</td>
            <td>${p.age}</td>
            <td>${fmt$(p.salary)}</td>
            <td>${p.years}</td>
            <td><span class="tag ${p.fatigue>80?"bad":p.fatigue>60?"warn":"good"}">${p.fatigue}</span></td>
            <td>
              ${p.inj>0 ? `<span class="tag warn">OUT ${p.inj}d</span>` : `<span class="tag good">Healthy</span>`}
              <div style="margin-top:6px;">
                <select data-rehab="${p.id}">
                  <option value="normal" ${p.rehab==="normal"?"selected":""}>æ­£å¸¸å¾©å¥</option>
                  <option value="fast" ${p.rehab==="fast"?"selected":""}>åŠ é€Ÿå¾©å¥ï¼ˆé¢¨éšªâ†‘ï¼‰</option>
                  <option value="force" ${p.rehab==="force"?"selected":""}>å¼·è¡Œå¾©å‡ºï¼ˆå¾©ç™¼â†‘â†‘ï¼‰</option>
                </select>
              </div>
            </td>
          </tr>
        `).join("")}
      </tbody>
    </table>

    <div class="hint" style="margin-top:10px;">
      é¤Šå‚·æç¤ºï¼šåŠ é€Ÿ/å¼·è¡Œå¯ä»¥ç¸®çŸ­ç¼ºé™£ï¼Œä½†å¾©ç™¼é¢¨éšªæœƒé£†ã€‚ç–²å‹å¤ªé«˜ä¹Ÿæ›´å®¹æ˜“å—å‚·ã€‚
    </div>
  `;

  $$("select[data-rehab]").forEach(sel=>{
    sel.onchange = ()=>{
      const pid = sel.getAttribute("data-rehab");
      const p = state.players.find(x=>x.id===pid);
      if(!p) return;
      p.rehab = sel.value;
      autosave();
      log(`ğŸ©º é¤Šå‚·ç­–ç•¥ï¼š${p.name} â†’ ${sel.value}`);
      render();
    };
  });
}

function renderLeague(){
  const east = state.teams.filter(t=>t.conf==="East").sort(sortStandings);
  const west = state.teams.filter(t=>t.conf==="West").sort(sortStandings);

  const table = (arr)=>`
    <table>
      <thead><tr><th>éšŠä¼</th><th>W</th><th>L</th><th>OVR</th><th>PF</th><th>PA</th><th>Diff</th></tr></thead>
      <tbody>
        ${arr.map(t=>{
          const diff = t.pf - t.pa;
          const tag = diff>120 ? "good" : diff<-120 ? "bad" : "warn";
          return `
            <tr>
              <td>${t.id} â€” ${escapeHtml(t.name)}</td>
              <td>${t.w}</td><td>${t.l}</td>
              <td>${teamOVR(t.id)}</td>
              <td>${Math.round(t.pf)}</td><td>${Math.round(t.pa)}</td>
              <td><span class="tag ${tag}">${diff>=0?"+":""}${Math.round(diff)}</span></td>
            </tr>
          `;
        }).join("")}
      </tbody>
    </table>
  `;

  $("#panelMain").innerHTML = `
    <h2>è¯ç›Ÿæ’å</h2>
    <div class="split">
      <div>
        <div class="row" style="margin-bottom:8px;"><span class="tag">Eastern Conference</span></div>
        ${table(east)}
      </div>
      <div>
        <div class="row" style="margin-bottom:8px;"><span class="tag">Western Conference</span></div>
        ${table(west)}
      </div>
    </div>
  `;
}

function pickTable(players, ns){
  return `
    <table>
      <thead><tr><th></th><th>çƒå“¡</th><th>Pos</th><th>OVR</th><th>Salary</th></tr></thead>
      <tbody>
        ${players.map(p=>`
          <tr>
            <td><input type="checkbox" data-ns="${ns}" value="${p.id}" /></td>
            <td>${escapeHtml(p.name)} ${p.inj>0?`<span class="tag warn">OUT</span>`:""}</td>
            <td>${p.pos}</td>
            <td>${p.ovr}</td>
            <td>${fmt$(p.salary)}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
}
function selectedIds(ns){
  return $$(`input[type="checkbox"][data-ns="${ns}"]:checked`).map(x=>x.value);
}

function renderTrade(){
  const my = state.myTeam;
  const others = TEAMS.filter(t=>t.id!==my);

  $("#panelMain").innerHTML = `
    <h2>äº¤æ˜“ä¸­å¿ƒ</h2>
    <div class="row" style="margin-bottom:10px;">
      <label class="muted">å°è±¡ï¼š</label>
      <select id="selTradeTeam">
        ${others.map(t=>`<option value="${t.id}">${t.id} â€” ${escapeHtml(t.name)}</option>`).join("")}
      </select>
      <button id="btnCheckTrade" class="primary">è©•ä¼°äº¤æ˜“</button>
      <button id="btnDoTrade">é€å‡ºä¸¦åŸ·è¡Œ</button>
      <span id="tradeMsg" class="muted"></span>
    </div>

    <div class="split">
      <div>
        <h2 style="margin:0 0 8px;">æˆ‘æ–¹é€å‡º</h2>
        ${pickTable(teamPlayers(my), "give")}
      </div>
      <div>
        <h2 style="margin:0 0 8px;">å°æ–¹é€å‡º</h2>
        <div id="tradeTheir"></div>
      </div>
    </div>
    <div class="hint" style="margin-top:10px;">
      äº¤æ˜“è¦å‰‡ï¼ˆç°¡åŒ–ï¼‰ï¼šè–ªè³‡éœ€å¤§è‡´åŒ¹é…ï¼ˆÂ±25%ï¼‰ï¼Œåƒ¹å€¼å·®è·ä¸èƒ½å¤ªèª‡å¼µã€‚
    </div>
  `;

  const sel = $("#selTradeTeam");
  const renderTheir = ()=>{
    const t = sel.value;
    $("#tradeTheir").innerHTML = pickTable(teamPlayers(t), "get");
  };
  sel.addEventListener("change", renderTheir);
  renderTheir();

  $("#btnCheckTrade").onclick = ()=>{
    const other = $("#selTradeTeam").value;
    const give = selectedIds("give");
    const get = selectedIds("get");
    if(give.length===0 || get.length===0){
      $("#tradeMsg").textContent = "è«‹è‡³å°‘å„é¸1äººã€‚";
      return;
    }
    const res = proposeTrade(give,get,other);
    $("#tradeMsg").innerHTML = res.accept
      ? `<span class="tag good">å¯æ¥å—</span> <span class="muted">åƒ¹å€¼ ${res.myVal.toFixed(1)} vs ${res.thVal.toFixed(1)}ï½œè–ªè³‡ ${fmt$(res.mySal)} vs ${fmt$(res.thSal)}</span>`
      : `<span class="tag bad">è¢«æ‹’çµ•</span> <span class="muted">${res.salaryOk?`åƒ¹å€¼å·®å¤ªå¤§ï¼ˆ${res.myVal.toFixed(1)} vs ${res.thVal.toFixed(1)}ï¼‰`:`è–ªè³‡ä¸åŒ¹é…ï¼ˆ${fmt$(res.mySal)} vs ${fmt$(res.thSal)}ï¼‰`}</span>`;
  };

  $("#btnDoTrade").onclick = ()=>{
    const other = $("#selTradeTeam").value;
    const give = selectedIds("give");
    const get = selectedIds("get");
    if(give.length===0 || get.length===0){ alert("è‡³å°‘å„é¸ 1 åçƒå“¡ã€‚"); return; }
    const res = proposeTrade(give,get,other);
    if(!res.accept){ alert("äº¤æ˜“è¢«æ‹’çµ•ï¼ˆå…ˆæŒ‰ã€Œè©•ä¼°äº¤æ˜“ã€çœ‹åŸå› ï¼‰ã€‚"); return; }
    executeTrade(give,get,other);
    log(`ğŸ¤ äº¤æ˜“å®Œæˆï¼šä½ é€å‡º ${give.length} äººï¼Œæ›å› ${get.length} äººï¼ˆå°è±¡ï¼š${other}ï¼‰`);
    render();
  };
}

function renderFA(){
  const my = state.myTeam;
  const cap = state.teams.find(t=>t.id===my).cap;
  const pay = payroll(my);
  const space = cap - pay;

  const canSign = (p)=> (pay + p.salary) <= cap;

  $("#panelMain").innerHTML = `
    <h2>è‡ªç”±å¸‚å ´ï¼ˆåªå…è¨±çœŸå¯¦çƒå“¡ï¼‰ <span class="tag">${space>=0? "ç©ºé–“ "+fmt$(space) : "è¶…å¸½ "+fmt$(Math.abs(space))}</span></h2>
    <div class="hint" style="margin-bottom:10px;">
      é€™è£¡ä¸æœƒäº‚ç”Ÿå‡åçƒå“¡ã€‚è‡ªç”±çƒå“¡ä¾†æºï¼šä½ åŒ¯å…¥çš„çœŸå¯¦ FA æˆ–ã€Œåˆ°æœŸåˆç´„ã€æµå…¥ã€‚<br/>
      ä½ ä¹Ÿå¯ä»¥åœ¨ã€ŒåŒ¯å…¥åå–®ã€é¡å¤–è²¼ <span class="tag">TEAM: FA</span> ä¾†åŒ¯å…¥çœŸå¯¦è‡ªç”±çƒå“¡åå–®ã€‚
    </div>

    <table>
      <thead><tr><th>çƒå“¡</th><th>Pos</th><th>OVR</th><th>Age</th><th>Salary</th><th></th></tr></thead>
      <tbody>
        ${state.fa
          .filter(p=>!isFakeName(p.name))
          .sort((a,b)=>b.ovr-a.ovr)
          .slice(0,80)
          .map(p=>`
          <tr>
            <td>${escapeHtml(p.name)}</td>
            <td>${p.pos}</td>
            <td>${p.ovr}</td>
            <td>${p.age}</td>
            <td>${fmt$(p.salary)}</td>
            <td><button ${canSign(p) ? "" : "disabled"} data-sign="${p.id}" class="${canSign(p) ? "primary" : ""}">ç°½ä¸‹</button></td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;

  $$("button[data-sign]").forEach(btn=>{
    btn.onclick = ()=>{
      const pid = btn.getAttribute("data-sign");
      const p = state.fa.find(x=>x.id===pid);
      if(!p) return;
      if(payroll(my) + p.salary > cap){ alert("è–ªè³‡ç©ºé–“ä¸è¶³ã€‚"); return; }
      p.team = my;
      state.players.push(p);
      state.fa = state.fa.filter(x=>x.id!==pid);
      autosave();
      log(`âœï¸ ç°½ç´„ï¼š${p.name}ï¼ˆ${p.pos}ï¼ŒOVR ${p.ovr}ï¼Œ${fmt$(p.salary)}ï¼‰`);
      render();
    };
  });
}

function renderImport(){
  $("#panelMain").innerHTML = `
    <h2>åŒ¯å…¥åå–®ï¼ˆå¼·åˆ¶çœŸå¯¦å§“åï¼‰</h2>
    <div class="hint" style="margin-bottom:10px;">
      æ ¼å¼ï¼š<span class="tag">TEAM: GSW</span> ç„¶å¾Œæ¯è¡Œï¼š<span class="tag">å§“å|ä½ç½®|OVR|å¹´é½¡|è–ªè³‡(M)|åˆç´„å¹´æ•¸</span><br/>
      ä½ å¿…é ˆæŠŠ 30 éšŠéƒ½åŒ¯å…¥ï¼ˆæ¯éšŠè‡³å°‘ 13 äººï¼‰ï¼Œæ¨¡æ“¬æ‰æœƒè§£é–ã€‚<br/><br/>
      âœ… åŒ¯å…¥è‡ªç”±çƒå“¡ï¼šç”¨ <span class="tag">TEAM: FA</span>ï¼ˆå¯é¸ï¼‰ã€‚<br/>
      â—åªè¦åµæ¸¬åˆ°ã€ŒFree Agent / Starter / #1234ã€ä¹‹é¡å‡åï¼Œæœƒç›´æ¥æ‹’çµ•åŒ¯å…¥ã€‚
    </div>
    <textarea id="taImport" rows="14" style="width:100%;"></textarea>
    <div class="row" style="margin-top:10px;">
      <button class="primary" id="btnImport">åŒ¯å…¥</button>
      <button class="ghost" id="btnImportExample">å¡«å…¥ç¯„ä¾‹ï¼ˆç¤ºæ„ï¼‰</button>
    </div>
  `;

  $("#btnImport").onclick = ()=>{
    const text = $("#taImport").value;
    // æ”¯æ´ TEAM: FA
    try{
      // ç‰¹åˆ¤ï¼šTEAM: FA çš„è¡Œï¼Œé€²å…¥è‡ªç”±å¸‚å ´
      const blocks = text.split(/\n---\n|\r\n---\r\n|\r\n---\n|\n---\r\n/);
      for(const block of blocks){
        const lines = block.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        if(lines.length===0) continue;
        const teamLine = lines.find(l=>/^TEAM\s*:/i.test(l));
        if(!teamLine) continue;
        const team = teamLine.split(":")[1].trim().toUpperCase();
        if(team==="FA"){
          // import FA: do not remove existing, just add
          for(const line of lines){
            if(/^TEAM\s*:/i.test(line)) continue;
            const parts = line.split("|").map(s=>s.trim());
            if(parts.length < 6) continue;
            const [name,pos,ovrS,ageS,salS,yearsS] = parts;
            if(isFakeName(name)) throw new Error(`åµæ¸¬åˆ°ç–‘ä¼¼å‡åï¼š${name}`);
            const p = P(name,pos,"FA",ovrS,ageS,salS,yearsS);
            state.fa.push(p);
          }
          log("ğŸ“¥ å·²åŒ¯å…¥è‡ªç”±çƒå“¡ï¼ˆTEAM: FAï¼‰ã€‚");
          continue;
        }else{
          importRoster(block);
        }
      }
      render();
    }catch(e){
      alert(e.message || String(e));
    }
  };

  $("#btnImportExample").onclick = ()=>{
    $("#taImport").value =
`TEAM: GSW
Stephen Curry|PG|96|37|52.0|2
Draymond Green|PF|82|35|24.0|2
Klay Thompson|SG|80|35|18.0|1
Jonathan Kuminga|SF|82|23|12.0|2
Andrew Wiggins|SF|79|30|26.0|2
---
TEAM: LAL
LeBron James|SF|92|41|51.0|1
Anthony Davis|PF|91|32|43.0|2
Austin Reaves|SG|81|27|13.0|2
D'Angelo Russell|PG|78|30|18.0|1
Rui Hachimura|PF|77|28|16.0|2`;
  };
}

/* =========================
   Init & Controls
========================= */
function init(){
  const raw = localStorage.getItem(SAVE_KEY);
  if(raw){
    try{ state = JSON.parse(raw); log("ğŸ“‚ å·²è‡ªå‹•è®€å–å­˜æª”ã€‚"); }
    catch(e){ state = newState(); }
  }else{
    state = newState();
  }

  // if locked team exists, apply
  const locked = localStorage.getItem(LOCK_KEY);
  if(locked && TEAMS.some(t=>t.id===locked)){
    state.myTeam = locked;
  }

  // Tabs
  $$(".tab").forEach(t=>{
    t.onclick = ()=>{
      $$(".tab").forEach(x=>x.classList.remove("on"));
      t.classList.add("on");
      currentTab = t.getAttribute("data-tab");
      render();
    };
  });

  // Team select (only before lock)
  $("#selMyTeam").onchange = (e)=>{
    const locked = localStorage.getItem(LOCK_KEY);
    if(locked){
      e.target.value = locked;
      alert("çƒéšŠå·²é–å®šï¼ˆé™¤éé‡ç½®ï¼‰ã€‚");
      return;
    }
    state.myTeam = e.target.value;
    autosave();
    render();
  };

  $("#btnLockTeam").onclick = ()=>{
    const locked = localStorage.getItem(LOCK_KEY);
    if(locked) return;
    localStorage.setItem(LOCK_KEY, state.myTeam);
    log(`ğŸ”’ çƒéšŠå·²é–å®šï¼š${state.myTeam}ï¼ˆé™¤éé‡ç½®ä¸å¯æ›´æ›ï¼‰`);
    autosave();
    render();
  };

  $("#btnSim1").onclick = ()=>{ simulateDay(); render(); };
  $("#btnSim7").onclick = ()=>{
    const gate = ensureCanSim();
    if(!gate.ok){ alert(gate.msg); return; }
    for(let i=0;i<7;i++) simulateDay();
    render();
  };

  $("#btnSimToEnd").onclick = ()=>{
    const gate = ensureCanSim();
    if(!gate.ok){ alert(gate.msg); return; }
    while(state.day <= state.schedule.length) simulateDay();
    if(!state.playoffsDone) runPlayoffs();
    autosave();
    render();
  };

  $("#btnNewSeason").onclick = ()=>{
    // å¿…é ˆå­£å¾Œè³½çµæŸæ‰è®“ä½ é€²ä¼‘è³½å­£ï¼ˆæ›´åƒçœŸå¯¦ï¼‰
    if(!state.playoffsDone){
      alert("è«‹å…ˆæ¨¡æ“¬åˆ°å­£æœ«ä¸¦å®Œæˆå­£å¾Œè³½ã€‚");
      return;
    }
    offseasonAdvance();
    log(`ğŸ—“ æ–°è³½å­£é–‹å§‹ï¼š${state.season}`);
    render();
  };

  $("#btnSave").onclick = save;
  $("#btnLoad").onclick = load;

  $("#btnReset").onclick = ()=>{
    if(!confirm("ç¢ºå®šé‡ç½®ï¼Ÿæœƒæ¸…æ‰é–å®šçƒéšŠèˆ‡å­˜æª”ã€‚")) return;
    localStorage.removeItem(SAVE_KEY);
    localStorage.removeItem(LOCK_KEY);
    state = newState();
    log("ğŸ§¹ å·²é‡ç½®ã€‚");
    render();
  };

  render();
  log("âœ… å•Ÿå‹•å®Œæˆï¼šå…ˆåŒ¯å…¥ 30 éšŠçœŸå¯¦åå–® â†’ é–å®šçƒéšŠ â†’ é–‹å§‹æ¨¡æ“¬ã€‚");
}

init();
</script>
</body>
</html>
